<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TrainYourAI Chat</title>
  <link rel="icon" href="data:,">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #101c33;
      --card: #1c2948;
      --accent: #6cf08d;
      --text: #f1f1f1;
      --subtext: #aaa;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background: #162447;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
    }
    .menu-icons {
      display: flex;
      gap: 16px;
    }
    .icon-button {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--accent);
      font-size: 18px;
    }
    .chat-area {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .bubble {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 14px;
      line-height: 1.4;
      font-size: 15px;
    }
    .user { align-self: flex-end; background: #2b3e60; }
    .bot { align-self: flex-start; background: var(--card); }
    .chat-input {
      display: flex;
      padding: 12px;
      background: #162447;
      border-top: 1px solid #2e456f;
    }
    .chat-input input {
      flex: 1;
      background: #1c2948;
      color: var(--text);
      border: none;
      padding: 10px;
      border-radius: 8px;
      margin-right: 10px;
    }
    .chat-input button {
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: 6px;
      padding: 10px 16px;
      cursor: pointer;
      font-weight: bold;
    }
    .drawer {
      position: fixed;
      top: 0;
      right: -300px;
      width: 280px;
      height: 100%;
      background: #192b4a;
      box-shadow: -2px 0 10px rgba(0,0,0,0.2);
      transition: right 0.3s ease;
      padding: 20px;
    }
    .drawer.open {
      right: 0;
    }
    .dashboard-button {
      position: absolute;
      top: 12px;
      left: 20px;
      background: transparent;
      color: var(--accent);
      border: 1px solid var(--accent);
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header>
    <button class="dashboard-button" onclick="location.href='/dashboard.html'">Dashboard</button>
    <h3>TrainYourAI Assistant</h3>
    <div class="menu-icons">
      <button class="icon-button" id="expert-icon">ðŸ“¦</button>
      <button class="icon-button" id="filter-icon">ðŸŽ­</button>
      <button class="icon-button" id="eye-icon">ðŸ“·</button>
    </div>
  </header>

  <div class="drawer" id="drawer">
    <h4>Personality Filters</h4>
    <p style="font-size: 14px; color: var(--subtext);">Customize tone, energy, or expression (coming soon).</p>
  </div>

  <div class="chat-area" id="chat-box">
    <div class="bubble bot">Hi there! I'm here to support you. Whatâ€™s on your mind?</div>
  </div>

  <div class="chat-input">
    <input id="user-input" type="text" placeholder="Type your message..." />
    <button id="send-button">Send</button>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    import { getVaultData } from './utils/vaultutils.ts';

    const GPT_API_KEY = "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";
    const supabase = createClient("https://vbgzzlowmszfqgshtuvd.supabase.co", "YOUR_ANON_KEY");

    let userVault = null;

    async function loadUserVault() {
      const { data: session } = await supabase.auth.getSession();
      const user_uid = session?.session?.user?.id;
      if (!user_uid) return;
      userVault = await getVaultData(user_uid);
    }

    function buildVaultPrompt(userInput) {
      const iv = userVault?.innerview || {};
      const ts = userVault?.tonesync || {};
      const ss = userVault?.skillsync || {};
      return `
[InnerView: Identity]
Name: ${iv.identity?.fullName || ""}
Profession: ${iv.workrole?.occupation || ""}
Beliefs: ${iv.beliefs?.coreValues?.join(', ') || ""}

[ToneSync]
- Directness: ${ts.directness || "neutral"}
- Encouragement: ${ts.encouragement || "medium"}
- Format: ${ts.format || "normal"}
- Follow-up: ${ts.followup || "auto"}
- Use "we" language: ${ts.we_language ? "Yes" : "No"}

[SkillSync]
${Object.entries(ss).map(([k,v]) => `- ${k}: ${v}`).join('\n')}

[User Message]
${userInput}
`; 
    }

    async function sendMessage() {
      const input = document.getElementById("user-input").value;
      if (!input) return;

      const chatBox = document.getElementById("chat-box");
      chatBox.innerHTML += `<div class='bubble user'>${input}</div>`;

      const prompt = buildVaultPrompt(input);
      const res = await fetch("/api/chat", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ userInput: input }),
});

const data = await res.json();
const reply = data.reply || "No response.";

      const data = await res.json();
      const reply = data.choices?.[0]?.message?.content || "No response.";
      chatBox.innerHTML += `<div class='bubble bot'>${reply}</div>`;
      document.getElementById("user-input").value = "";
    }

    function toggleDrawer() {
      document.getElementById("drawer").classList.toggle("open");
    }

    window.addEventListener("DOMContentLoaded", () => {
      loadUserVault();
      document.getElementById("send-button").addEventListener("click", sendMessage);
      document.getElementById("filter-icon").addEventListener("click", toggleDrawer);
      document.getElementById("expert-icon").addEventListener("click", () => alert("Expert Packs coming soon"));
      document.getElementById("eye-icon").addEventListener("click", () => alert("A-Eye camera coming soon"));
    });
  </script>
</body>
</html>